# íŒŒì¼ ì´ë¦„: .github/workflows/main.yml

name: AI Security Review Bot Runner # ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì…ë‹ˆë‹¤.

# 1. ì–¸ì œ ì‹¤í–‰í• ì§€ ì„¤ì • (íŠ¸ë¦¬ê±°)
on:
  pull_request:
    # PRì´ ì—´ë¦¬ê±°ë‚˜(opened), ì—…ë°ì´íŠ¸ë˜ê±°ë‚˜(synchronize), ë‹¤ì‹œ ì—´ë¦´ ë•Œ(reopened) ì‹¤í–‰
    types: [opened, synchronize, reopened] 

# 2. ìˆ˜í–‰í•  ì‘ì—…(Job) ì •ì˜
jobs:
  security_analysis: # ì´ ì‘ì—…ì˜ ì´ë¦„ì€ 'security_analysis'ì…ë‹ˆë‹¤.
    runs-on: ubuntu-latest # GitHubê°€ ì œê³µí•˜ëŠ” ê°€ìƒ Linux í™˜ê²½ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.

    # 3. ë‹¨ê³„ë³„ ì‹¤í–‰ (Steps)
    steps:
      
      # 3-1. Git ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)
      - name: Checkout Code
        uses: actions/checkout@v4 # ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.
      
      # 3-2. Python í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Python 3 ë²„ì „ ì‚¬ìš©ì„ ëª…ì‹œí•©ë‹ˆë‹¤.

      # 3-3. Python ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (Checkov ì„¤ì¹˜ ì¤€ë¹„)
      - name: Install Dependencies (checkov)
        run: |
          pip install checkov 
          
      # 3-4. Checkov ì‹¤í–‰ ë° ê²°ê³¼ JSON íŒŒì¼ ì €ì¥ (í•µì‹¬)
      - name: Run Checkov Scan and Save JSON
        # 'run:' ì•„ë˜ì— í„°ë¯¸ë„ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
        run: |
          # 'main.tf' íŒŒì¼ì„ ìŠ¤ìº”í•˜ì—¬ ê²°ê³¼ë¥¼ result.json íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤.
          checkov -f main.tf -o json --output-file findings.json
          echo "findings.json íŒŒì¼ ì €ì¥ ì™„ë£Œ."
          
      # (ë‹¤ìŒ ë‹¨ê³„: Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì€ ë‹¤ìŒ ì‘ì—…ì—ì„œ ì¶”ê°€í•©ë‹ˆë‹¤.)
      - name: Run AI Review Script
        env:
          # ğŸš¨ğŸš¨ GitHub Secretsì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ ğŸš¨ğŸš¨
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
          GITHUB_PAT: ${{ secrets.MY_GITHUB_TOKEN }}
          
          # ğŸš¨ PR ë²ˆí˜¸ ë° ì €ì¥ì†Œ ì •ë³´ë¥¼ Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ë‹¬
          PR_NUMBER: ${{ github.event.pull_request.number }} # PR ë²ˆí˜¸ë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜´
          GITHUB_REPOSITORY: ${{ github.repository }} # "user/repo" í˜•ì‹ì˜ ì €ì¥ì†Œ ì´ë¦„ì„ ê°€ì ¸ì˜´
          
        run: |
          # main.py ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ AI ë¶„ì„ ë° ëŒ“ê¸€ ê²Œì‹œë¥¼ ëª…ë ¹
          python main.py